{% extends "admin/change_list.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}


<style>

    .cards{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(520px,1fr));
    gap:18px;
    margin-top:20px;
}

/* âœ… Card */
.card{
    background:#fff;
    border-radius:14px;
    box-shadow:0 10px 25px rgba(0,0,0,.08);
    padding:14px;
    width:100%;
    overflow:hidden;
    border:1px solid #eef2f7;
}

/* HEADER */
.header{
    display:flex;
    align-items:center;
    gap:10px;
}

/* LOGO / AVATAR */
.logo{
    width:44px;
    height:44px;
    background:#f3f4f6;
    border-radius:10px;
    overflow:hidden;
    flex:0 0 auto;
}
.logo img{
    width:100%;
    height:100%;
    object-fit:cover;
}

.title{
    font-size:16px;
    font-weight:800;
    line-height:1.2;
    color:#0f172a;
}
.small{
    font-size:12px;
    color:#6b7280;
    margin-top:2px;
}

/* TEXT */
.meta{
    font-size:13px;
    color:#555;
    margin-top:5px;
    word-break:break-word;      /* âœ… Address / website cut fix */
    overflow-wrap:anywhere;     /* âœ… long text wrap */
}

/* BADGES */
.badge{
    display:inline-block;
    padding:4px 10px;
    font-size:12px;
    border-radius:20px;
    background:#eef2ff;
    margin:6px 6px 0 0;
    white-space:nowrap;
}
.green{background:#dcfce7;color:#166534}
.red{background:#fee2e2;color:#991b1b}
.blue{background:#dbeafe;color:#1d4ed8}
.yellow{background:#fef9c3;color:#854d0e}
.gray{background:#f3f4f6;color:#111827}

/* Divider */
.hr{
    border:none;
    border-top:1px solid #e5e7eb;
    margin:9px 0;
}

/* ACTIONS */
.actions{
    margin-top:10px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
}
.actions a{
    padding:9px 14px;
    border-radius:999px;
    font-size:13px;
    font-weight:800;
    display:inline-flex;
    align-items:center;
    gap:7px;
    text-decoration:none;
    white-space:nowrap;
}
.call-btn{background:#0f766e;color:#fff;}
.whatsapp-btn{background:#25D366;color:#fff;}
.edit-btn{border:1px solid #ddd;color:#111;background:#fff;}
.map-btn{background:#111827;color:#fff;}
.actions a i{font-size:15px;}

/* Rating Stars */
.stars{
    display:flex;
    gap:6px;
    align-items:center;
    margin-top:5px;
    flex-wrap:wrap;
}
.star-badge{
    padding:4px 10px;
    border-radius:20px;
    background:#fff7ed;
    color:#9a3412;
    border:1px solid #fed7aa;
    font-size:12px;
    font-weight:800;
}
.review-badge{
    padding:4px 10px;
    border-radius:20px;
    background:#f3f4f6;
    color:#111;
    font-size:12px;
    font-weight:800;
}

/* âœ… MOBILE FIX */
@media (max-width: 640px){
    .cards{
        grid-template-columns:1fr !important;
        gap:14px !important;
        padding:0 6px !important;
    }

    .card{
        width:100% !important;
        padding:14px !important;
        border-radius:16px !important;
    }

    /* âœ… Admin content fit */
    #content{
        padding:10px !important;
    }

    /* âœ… No horizontal scroll */
    #container, .content, .results{
        max-width:100% !important;
        overflow-x:hidden !important;
    }

    /* âœ… buttons full width on mobile */
    .actions a{
        flex:1;
        min-width:120px;
        justify-content:center;
    }
}

</style>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
{% endblock %}


{% block result_list %}
<div class="cards">
{% for obj in cl.result_list %}
<div class="card">

    <!-- ================= HEADER ================= -->
    <div class="header">
        <div class="logo" style="display:flex;align-items:center;justify-content:center;">
      <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="default">
    </div>


        <div style="flex:1">
            <div class="title">
                <span class="badge green">G{{ obj.id|stringformat:"03d" }}</span>
                {{ obj.name }}
            </div>

            <div class="small">
                {% if obj.category_text %}
                    {{ obj.category_text }}
                {% endif %}
                {% if obj.type %}
                    â€¢ {{ obj.type }}
                {% endif %}
            </div>

            <!-- â­ Rating -->
            <div class="stars">
                {% if obj.rating %}
                    <span class="star-badge">
                        â­ {{ obj.rating }}
                    </span>
                {% endif %}
                {% if obj.reviews %}
                    <span class="review-badge">
                        {{ obj.reviews }} Reviews
                    </span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ================= STATUS ROW ================= -->
    <div style="margin-top:6px;">
        <span class="badge blue">{{ obj.status|default:"New" }}</span>

        {% if obj.business_status %}
            <span class="badge yellow">{{ obj.business_status }}</span>
        {% endif %}

        {% if obj.city_text %}
            <span class="badge gray">ğŸ“ {{ obj.city_text }}</span>
        {% endif %}
    </div>

    <hr class="hr">

    <!-- ================= ADDRESS ================= -->
    <div class="meta">
        ğŸ“Œ <strong>Address:</strong>
        {{ obj.address|default:"â€”" }}
    </div>

    <div class="meta">
        ğŸ˜ <strong>Street:</strong>
        {{ obj.street|default:"â€”" }}
    </div>

    <div class="meta">
        ğŸ“ <strong>Locality:</strong>
        {{ obj.locality|default:"â€”" }}
        {% if obj.sub_locality %} â€¢ {{ obj.sub_locality }} {% endif %}
    </div>

    <div class="meta">
        ğŸ™ <strong>City:</strong>
        {{ obj.city|default:"â€”" }}
        {% if obj.state %} â€¢ {{ obj.state }} {% endif %}
        {% if obj.postal_code %} â€¢ {{ obj.postal_code }} {% endif %}
    </div>
    <div class="meta">        

        ğŸŒ <strong>Website:</strong>
        {% if obj.website %}
            <a href="{{ obj.website }}" target="_blank">{{ obj.website }}</a>
        {% else %}
            â€”
        {% endif %}
    </div>

    <hr class="hr">

    <!-- ================= FOLLOWUP (if exists) ================= -->
    {% if obj.followup %}
    <div class="meta">
        ğŸ“Œ <strong>Followup:</strong><br>
        âœ… <strong>Status:</strong> {{ obj.followup.status|default:"â€”" }} <br>
        ğŸ“… <strong>Date:</strong> {{ obj.followup.followup_date|date:"d M Y, h:i A"|default:"â€”" }} <br>
        ğŸ‘¤ <strong>Assigned:</strong> {{ obj.followup.assigned_to|default:"â€”" }} <br>
        ğŸ’¬ <strong>Comment:</strong> {{ obj.followup.comment|default:"â€”" }}
    </div>
    <hr class="hr">
    {% endif %}

    <!-- ================= MEETING (if exists) ================= -->
    {% if obj.meeting %}
    <div class="meta">
        ğŸ¤ <strong>Meeting:</strong><br>
        âœ… <strong>Status:</strong> {{ obj.meeting.status|default:"â€”" }} <br>
        ğŸ“… <strong>Date:</strong> {{ obj.meeting.meeting_date|date:"d M Y, h:i A"|default:"â€”" }} <br>
        ğŸ‘¤ <strong>Assigned:</strong> {{ obj.meeting.assigned_to|default:"â€”" }} <br>
        ğŸ’¬ <strong>Comment:</strong> {{ obj.meeting.comment|default:"â€”" }}
    </div>
    <hr class="hr">
    {% endif %}

    <!-- ================= LAST COMMENT (if exists) ================= -->
    {% with last_comment=obj.comments.last %}
        {% if last_comment %}
        <div class="meta">
            ğŸ’¬ <strong>Last Comment:</strong> {{ last_comment.comment|truncatechars:120 }} <br>
            ğŸ‘¤ <strong>By:</strong> {{ last_comment.created_by|default:"â€”" }} |
            ğŸ•’ {{ last_comment.create_at|date:"d M Y, h:i A"|default:"â€”" }}
        </div>
        <hr class="hr">
        {% endif %}
    {% endwith %}

    <!-- ================= LAST VISIT (if exists) ================= -->
    {% with last_visit=obj.visits.last %}
        {% if last_visit %}
        <div class="meta">
            ğŸš— <strong>Last Visit:</strong><br>
            âœ… <strong>Type:</strong> {{ last_visit.visit_type|default:"â€”" }} <br>
            ğŸ“Œ <strong>Status:</strong> {{ last_visit.visit_status|default:"â€”" }} <br>
            ğŸ‘¤ <strong>By:</strong> {{ last_visit.uploaded_by|default:"â€”" }} |
            ğŸ•’ {{ last_visit.uploaded_at|date:"d M Y, h:i A"|default:"â€”" }}
            {% if last_visit.comment %}
              <br>ğŸ’¬ <strong>Note:</strong> {{ last_visit.comment|truncatechars:120 }}
            {% endif %}
        </div>
        <hr class="hr">
        {% endif %}
    {% endwith %}

    <!-- ================= LAST VOICE RECORDING (if exists) ================= -->
    {% with last_voice=obj.voice_recordings.last %}
        {% if last_voice %}
        <div class="meta">
            ğŸ¤ <strong>Voice Recording:</strong><br>
            ğŸ“‚ <a href="{{ last_voice.file.url }}" target="_blank">Play / Download</a> <br>
            ğŸ‘¤ <strong>By:</strong> {{ last_voice.uploaded_by|default:"â€”" }} |
            ğŸ•’ {{ last_voice.uploaded_at|date:"d M Y, h:i A"|default:"â€”" }}
        </div>
        <hr class="hr">
        {% endif %}
    {% endwith %}


    <hr class="hr">

    <!-- ================= AUDIT ================= -->
    <div class="meta">
        ğŸ‘¤ Created: {{ obj.created_by|default:"â€”" }},
        {{ obj.created_at|date:"d M Y, h:i A"|default:"â€”" }}<br>
        âœï¸ Updated: {{ obj.updated_by|default:"â€”" }},
        {{ obj.updated_at|date:"d M Y, h:i A"|default:"â€”" }}
    </div>

    <!-- ================= ACTIONS ================= -->
    <div class="actions">

        <!-- ğŸ“ CALL -->
        {% if obj.phone %}
        <a class="call-btn" href="tel:{{ obj.phone }}">
            <i class="fas fa-phone"></i>
            Call
        </a>
        {% endif %}

        <!-- ğŸ’¬ WHATSAPP -->
        {% if obj.phone %}
        <a class="whatsapp-btn"
           href="https://wa.me/{{ obj.phone|cut:'+' }}?text=Hello%20{{ obj.name }}"
           target="_blank">
            <i class="fab fa-whatsapp"></i>
            WhatsApp
        </a>
        {% endif %}

        <!-- ğŸ—º MAP -->
        {% if obj.latitude and obj.longitude %}
        <a class="map-btn"
           href="https://www.google.com/maps?q={{ obj.latitude }},{{ obj.longitude }}"
           target="_blank">
            <i class="fa-solid fa-location-dot"></i>
            Map
        </a>
        {% endif %}

        <a class="edit-btn"
            href="{% url 'admin:realtypms_googlecompany_change' obj.id %}?_changelist_filters={{ request.GET.urlencode }}">
                <i class="fas fa-pen"></i>
                Edit
       </a>


    </div>

</div>
{% endfor %}
</div>
{% endblock %}
